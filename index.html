<!DOCTYPE html>
<html>
<header>
	<title>Sail</title>
	<link rel="stylesheet" type="text/css" href="style.css">
	<script>
    
    // Minigame
    
    var minigameFps = 60;
    var minigameTimeStep;
    
    var minigamePoints;
    var minigamePointsPerDistance = 0.1;
    
    var minigameLevel = 0;
    var minigameLevelDuration = 10;
    var minigameNumLevels = 5;
    
    var minigameLevelTimer;
    
    var points;
    
    var minigameState;
    var minigameStateWelcome    = 0;
    var minigameStatePlay       = 1;
    var minigameStateGameOver   = 2;
    
    // Menus
    var gameOver;
    var welcome;
    
    
    // Input
    
    var inputJumpWasPressed;
    
    // Sound
    
    var soundIsPlaying;
    var soundBackgroundMusicVolume = 0.5;
    var soundBackgroundMusic;
    var soundJumpVolume = 0.15;
    var soundJump;
    
    // Scene
    
    var sceneSpeedX = [-300, -400, -500];
    
    var sceneWidth = 900;
    
    // Ship

    var shipStartPosX = 130;
    var shipStartPosY = 260;
    
    var shipJumping;
    var shipJumpSpeed = -500;
    var shipSpeedY = 0;
    var shipGravity = 1200.0;
    
    var shipPosX;
    var shipPosY;
    var shipWidth = 147;
    var shipHeight = 68;
    
    var shipCollisionWidth = 40;
    
    var ship;
    
    // Sticks
    
    var stickKillDistance = 1200;
    var stickSeparation = [500, 200, 100];
    var stickSpawnChances = [2, 4, 5]
    
    var stickSpawnLeftPosX = 300;
    var stickSpawnRightPosX = 600;

    var stickTopPosY = [290, 270, 250];

    var sticks;
    var numSticks = 20;
    var stickWidth = 51;
    var stickHeight = 155;
    
    var stickPositionsX;
    var stickPositionsY;
    
    var stickLastSpawnChanceIndex;
    
    var ship;
    
    function MinigameInitPlay()
    {
        points = document.getElementById("points");
        ship = document.getElementById("ship");

        sticks = new Array();
        stickPositionsX = new Array();
        stickPositionsY = new Array();
        
        for(var i = 0; i < numSticks; i++)
        {
            sticks.push(document.getElementById("stick" + (i + 1)));            
           
            stickPositionsX.push(0);
            stickPositionsY.push(0);
            
            sticks[i].style.display = "none";
        }

        points.style.display = "none";            
            
    }
    
    function MinigameEnterPlay()
    {
        // Init minigame
        
        minigameLevel = 0;
        minigameNumLevels = 3;
        minigameLevelTimer = minigameLevelDuration;
    
        minigamePoints = 0;
        points.innerHTML = 0;        
        points.style.display = "block";

        // Init ship
        
        shipPosX = shipStartPosX;
        shipPosY = shipStartPosY;
        
        ship.style.left = shipPosX + "px";
        ship.style.top = shipPosY + "px";
        
        shipJumping = false;
        shipSpeedY = 0;
        ship.style.rotate = "0deg";        
        
        for(var i = 0; i < numSticks; i++)
        {
            sticks.push(document.getElementById("stick" + (i + 1)));            
           
            stickPositionsX[i] = sceneWidth;
            stickPositionsY[i] = stickTopPosY[minigameLevel];
            
            sticks[i].style.left = stickPositionsX[i] + "px";
            sticks[i].style.top = stickPositionsY[i] + "px";
            
            sticks[i].style.display = "none";
            
        }
        
        sticks[0].style.display = "block";
        stickPositionsX[0] = sceneWidth;
        stickLastSpawnChanceIndex = 0;
    
    }
    
    function MinigameExitPlay()
    {
        points.style.display = "none";
    }    
    
    function MinigameInitWelcome()
    {
        welcome = document.getElementById("welcome");
        welcome.style.display = "none";
    }
    
    function MinigameEnterWelcome()
    {       
        welcome.innerHTML = "<div style='font-size:50px'>Sailor of the Myst</div>" +
                            "<div style='font-size:20px; margin-top:20px'>Click to start</div>";
        
        welcome.style.display = "block";
    }
    
    function MinigameFinishWelcome()
    {
        welcome.style.display = "none";
        console.log("Finishing welcome");
    }
    
    function MinigameUpdateWelcome()
    {
        if(inputJumpWasPressed)
        {
            MinigameFinishWelcome();
            MinigameEnterPlay();
            minigameState = minigameStatePlay;
            
            if(!soundIsPlaying)
            {
                soundBackgroundMusic.play();
                soundIsPlaying = true;
            }

        }
    }
    
    function MinigameInitGameOver()
    {
        gameOver = document.getElementById("gameOver");
        gameOver.style.display = "none";
    }
    
    function MinigameEnterGameOver()
    {
        gameOver.style.display = "block";
        
        gameOver.innerHTML = "<div>Game Over!</div><div style='font-size:30px'>points " + (Math.floor(minigamePoints / 10) * 10) +                     "</div>" + "<div style='font-size:20px; margin-top:20px'>Click to play again</div>"
    
    }
    
    function MinigameInit()
    {    
        
        soundJump = document.getElementById("jumpSound");
        soundJump.volume = soundJumpVolume;

        soundBackgroundMusic = document.getElementById("backgroundMusic");
        soundBackgroundMusic.volume = soundBackgroundMusicVolume;

        soundIsPlaying = false;
        
        MinigameInitPlay();        
        MinigameInitWelcome();
        MinigameInitGameOver();
        
        MinigameEnterWelcome();
        minigameState = minigameStateWelcome;
        
        document.addEventListener('keydown', MinigameOnKeyDown);
        document.addEventListener('click', MinigameOnClick);
        
        
        minigameTimeStep = 1.0 / minigameFps;
        window.setTimeout(MinigameUpdate, 1000.0 / minigameFps );
    }
    
    function MinigameUpdateGameOver()
    {
        if(inputJumpWasPressed)
        {
            MinigameExitGameOver();
            minigameState = minigameStatePlay;
            MinigameEnterPlay();
            console.log("Going to play");
        }
    }
    
    function MinigameExitGameOver()
    {
        gameOver.style.display = "none";    
    }

    function MinigameUpdatePlay()
    {
        // Update level
        
        if(minigameLevel < minigameNumLevels - 1)
        {
            minigameLevelTimer -= minigameTimeStep;
            if(minigameLevelTimer < 0)
            {
                minigameLevelTimer = minigameLevelDuration;
                minigameLevel ++;
                
                console.log("increasing level");
            }
        }
        
        // Update points
        
        minigamePoints += minigamePointsPerDistance *
                          Math.abs(sceneSpeedX[minigameLevel]) * minigameTimeStep;
                          
        points.innerHTML = Math.floor(minigamePoints / 10) * 10;
        
        // Update ship
        
        if(inputJumpWasPressed && !shipJumping)
        {
            shipSpeedY = shipJumpSpeed;
            shipJumping = true;
            soundJump.play();
            ship.style.rotate = "-10deg";        
        }    

        if(shipJumping)
        {
            shipPosY += shipSpeedY * minigameTimeStep;
            shipSpeedY += shipGravity * minigameTimeStep;
            
            if(shipSpeedY >= 0 && shipPosY > shipStartPosY)
            {
                shipPosY = shipStartPosY;
                shipSpeedY = 0;

                shipJumping = false;

                ship.style.rotate = "0deg";        
            }
        }
        
        for(var i = 0; i < numSticks; i++)
        {
            if(sticks[i].style.display != "none")
            {
                if(Math.abs(stickPositionsX[i] + stickWidth / 2 - (shipPosX + shipWidth / 2)) < shipCollisionWidth &&
                    shipPosY + shipHeight >= stickPositionsY[i])
                {
                    MinigameExitPlay();
                    minigameState = minigameStateGameOver;
                    MinigameEnterGameOver();
                }
                    
            }
        }
        
        ship.style.left = shipPosX + "px";
        ship.style.top = shipPosY + "px";    

        // Update sticks

        var spawnChance = Math.floor((Math.random() * 1000)) % stickSpawnChances[minigameLevel];

        if(sceneWidth - stickPositionsX[stickLastSpawnChanceIndex] > stickSeparation[minigameLevel])
        {
            var found = false;
            var i = 0;
            while(!found && i < numSticks)
            {
                if(sticks[i].style.display == "none")
                {
                    if(spawnChance == 0)
                    {
                        sticks[i].style.display = "block";
                    }
                    else
                    {
                        sticks[i].style.display = "none";
                    }
                    stickPositionsX[i] = sceneWidth;
                    stickPositionsY[i] = stickTopPosY[minigameLevel];
                    stickLastSpawnChanceIndex = i;
                    found = true;
                }
                else
                {
                    i++;
                }
            }
        }
        else
        {
            stickLastSpawnChanceIndex  
        }

        
        for(var i = 0; i < numSticks; i++)
        {
        
            stickPositionsX[i] += sceneSpeedX[minigameLevel] * minigameTimeStep;
        
            if(stickPositionsX[i] <= -stickKillDistance)
            {
                sticks[i].style.display = "none";
            }
            else
            {
                sticks[i].style.left = stickPositionsX[i] + "px";
                sticks[i].style.top = stickPositionsY[i] + "px";
            }
            
            
        }
    
    }
   
    function MinigameUpdate()
    {
        if(minigameState == minigameStateWelcome)
        {
            MinigameUpdateWelcome();  
            console.log("update welcome");
        }
        else if(minigameState == minigameStatePlay)
        {
            MinigameUpdatePlay();
        }
        else // minigameState == minigameStateGameOver
        {
            MinigameUpdateGameOver();
        }
    
        inputJumpWasPressed = false;

        window.setTimeout(MinigameUpdate, 1000.0 / minigameFps );
    }
    
    function MinigameOnKeyDown(e)
    {
        if(e.key == " ")
        {
            inputJumpWasPressed = true;
        }
    }
    
    function MinigameOnClick(e)
    {
        inputJumpWasPressed = true;
    }

	</script>
</header>
<body>
	<div id="minigame">
		<img id="seaBackground" src="images/sea-background.png">
		<img id="stick1" class="stick" src="images/stick.png">
		<img id="stick2" class="stick" src="images/stick.png">
		<img id="stick3" class="stick" src="images/stick.png">
		<img id="stick4" class="stick" src="images/stick.png">
		<img id="stick5" class="stick" src="images/stick.png">
		<img id="stick6" class="stick" src="images/stick.png">
		<img id="stick7" class="stick" src="images/stick.png">
		<img id="stick8" class="stick" src="images/stick.png">
		<img id="stick9" class="stick" src="images/stick.png">
		<img id="stick10" class="stick" src="images/stick.png">
		<img id="stick11" class="stick" src="images/stick.png">
		<img id="stick12" class="stick" src="images/stick.png">
		<img id="stick13" class="stick" src="images/stick.png">
		<img id="stick14" class="stick" src="images/stick.png">
		<img id="stick15" class="stick" src="images/stick.png">
		<img id="stick16" class="stick" src="images/stick.png">
		<img id="stick17" class="stick" src="images/stick.png">
		<img id="stick18" class="stick" src="images/stick.png">
		<img id="stick19" class="stick" src="images/stick.png">
		<img id="stick20" class="stick" src="images/stick.png">
		<img id="ship" src="images/ship.png">
		<img id="seaForeground" src="images/sea-foreground.png">
		<img id="vignette" src="images/vignette.png">
        <audio id="jumpSound" src="sounds/jump.wav"></audio>
        <audio id="backgroundMusic" src="sounds/background.wav"></audio>
        <div id="points">0</div>
        <div id="gameOver"><div>Game over!</div><div>score 210</div></div>
        <div id="welcome"><div>Sail</div><div>click to start</div></div>
	</div>
<script>

	// Initialization
	
	MinigameInit();
</script>
</body>
</html>